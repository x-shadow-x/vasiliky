module.controller("songCtrl",["$scope","$http","request",function($scope,$http,request){function init(){initComponents(),initEventClick();for(var i=0;i<$scope.songsList.length;i++)$scope.songsList[i].musicURL=encodeURI($scope.songsList[i].musicURL);myAudio.src=decodeURI($scope.songsList[$scope.songsListIndex].musicURL),myAudio.addEventListener("ended",function(){controllArm.style.transform="rotate(-130deg)","list"==playMode?($scope.songsListIndex++,$scope.songsListIndex>=$scope.songsList.length&&($scope.songsListIndex=0)):"shuffle"==playMode?$scope.songsListIndex=shuffle():$scope.songsListIndex=$scope.songsListIndex,myAudio.src=decodeURI($scope.songsList[$scope.songsListIndex].musicURL),myAudio.load(),iStartDeg=-90,iEndDeg=-115,$scope.$apply(),myAudio.play()},!1),myAudio.addEventListener("play",function(){$cdCover.removeClass("cdPause"),$cdCover.addClass("cdStart")},!1),myAudio.addEventListener("timeupdate",function(){var $myCon=$("#myConsole");if(isNaN(myAudio.duration))$myCon.text("error");else{var progressValue=myAudio.currentTime/myAudio.duration;if(myAudio.paused)return;iStartDeg=-90-25*progressValue,controllArm.style.transform="rotate("+iStartDeg+"deg)",$myCon.text($scope.songsList[$scope.songsListIndex%$scope.songsList.length].title+"-"+$scope.songsList[$scope.songsListIndex%$scope.songsList.length].artist);var widthline=100*progressValue;progressBar.style.width=widthline+"%"}},!1)}function play(){$playBtnI.removeClass("icon-play").addClass("icon-pause"),iIncrement=iStartDeg-iEndDeg,controllArm.style.transform="rotate("+iStartDeg+"deg)",$cdCover.hasClass("cdPause")&&($cdCover.removeClass("cdPause"),$cdCover.removeClass("cdStart")),$cdCover.hasClass("cdStart")||$cdCover.addClass("cdStart"),myAudio.play()}function pause(){$playBtnI.removeClass("icon-pause").addClass("icon-play"),controllArm.style.transform="rotate(-130deg)",$cdCover.hasClass("cdPause")||$cdCover.addClass("cdPause"),myAudio.pause()}function reload(){$scope.pageSearchList={pn:1,ps:3,pl:3,songId:$scope.songsListIndex+1,"switch":!0}}function initEventClick(){$shuffleMode.click(function(){playMode="shuffle",$("#playMode").find("div").css({color:"#b1b9c6"}),$(this).css({color:"#e74d3c"})}),$listMode.click(function(){playMode="list",$("#playMode").find("div").css({color:"#b1b9c6"}),$(this).css({color:"#e74d3c"})}),$loopMode.click(function(){playMode="loop",$("#playMode").find("div").css({color:"#b1b9c6"}),$(this).css({color:"#e74d3c"})})}function initComponents(){$nextBtn=$("#nextBtn"),$preBtn=$("#preBtn"),$stopBtn=$("#stopBtn"),$muteBtnI=$("#muteBtn").find("i").eq(0),$shuffleMode=$("#shuffleMode"),$listMode=$("#listMode"),$loopMode=$("#loopMode"),myAudio=$("#myAudio")[0],controllArm=$("#cdControllerArm")[0],$playBtnI=$("#playBtn").find("i").eq(0),$cdCover=$("#cdCover"),iStartDeg=-90,iEndDeg=-115,iIncrement=25,playMode="list",isMouseDown=!1,progressBar=$("#progressBar")[0],$progressBarBox=$("#progressBarBox"),progressBarWidth=$progressBarBox.width(),$progressBarNode=$("#progressBarNode"),console.log($progressBarNode),$("#listMode").css({color:"#e74d3c"}),shuffleIndex=[],shuffleIndexCount=$scope.songsList.length-1,initShuffleGenerator()}function initShuffleGenerator(){for(var i=0;i<$scope.songsList.length;i++)shuffleIndex[i]=i}function shuffle(){var tem=getRandom(shuffleIndexCount),tem2=shuffleIndex[tem];return shuffleIndex[tem]=shuffleIndex[shuffleIndexCount],shuffleIndexCount--,shuffleIndexCount<0&&(shuffleIndexCount=$scope.songsList.length),tem2}function changeSong(whatDirection){0!=myAudio.currentTime&&(myAudio.paused||($cdCover.hasClass("cdPause")&&($cdCover.removeClass("cdPause"),$cdCover.removeClass("cdStart")),$cdCover.hasClass("cdStart")||$cdCover.addClass("cdStart"),controllArm.style.transform="rotate(-130deg)","pre"==whatDirection?($scope.songsListIndex--,console.log($scope.songsListIndex,"================Xx"),$scope.songsListIndex<0&&($scope.songsListIndex=$scope.songsList.length-1)):"next"==whatDirection?($scope.songsListIndex++,$scope.songsListIndex>=$scope.songsList.length&&($scope.songsListIndex=0)):"first"==whatDirection?$scope.songsListIndex=0:"last"==whatDirection&&($scope.songsListIndex=$scope.songsList.length-1),reload(),myAudio.src=decodeURI($scope.songsList[$scope.songsListIndex].musicURL),myAudio.load(),myAudio.play()))}function getRandom(n){return Math.floor(Math.random()*n+1)}function getQueryObject(){var url=window.location.href,search=url.substring(url.lastIndexOf("?")+1),obj={},reg=/([^?&=]+)=([^?&=]*)/g;return search.replace(reg,function(rs,$1,$2){var name=decodeURIComponent($1),val=decodeURIComponent($2);return val=String(val),obj[name]=val,rs}),obj}var $nextBtn,$preBtn,$stopBtn,$shuffleMode,$listMode,$loopMode,myAudio,controllArm,$cdCover,iStartDeg,iEndDeg,iIncrement,playMode,shuffleIndex,shuffleIndexCount,$playBtnI,$muteBtnI,progressBar;$scope.songsListIndex=getQueryObject().id-1,$scope.handlePreBtn=function(){changeSong("pre")},$scope.handlePlayBtn=function(){$playBtnI.hasClass("icon-play")?play():pause()},$scope.handleNextBtn=function(){changeSong("next")},$scope.handleStopBtn=function(){controllArm.style.transform="rotate(-130deg)",$cdCover.removeClass("cdPause"),$cdCover.removeClass("cdStart"),myAudio.load()},$scope.handleMuteBtn=function(){$muteBtnI.hasClass("icon-volume-up")?$muteBtnI.removeClass("icon-volume-up").addClass("icon-volume-off"):$muteBtnI.removeClass("icon-volume-off").addClass("icon-volume-up"),myAudio.muted=!myAudio.muted},Number.prototype.toPercent=function(n){return n=n||2,(Math.round(this*Math.pow(10,n+2))/Math.pow(10,n)).toFixed(n)+"%"},$scope.submitComment=function(){console.log($scope.commentContent);var time=new Date,datas={songId:$scope.songsListIndex+1};datas.content={songId:$scope.songsListIndex+1,user:"匿名",time:time.getFullYear()+"-"+(time.getMonth()+1)+"-"+time.getDate()+" "+time.getHours()+":"+time.getMinutes()+":"+time.getSeconds(),text:$scope.commentContent};var param={url:"http://anewsong.duapp.com/get-comment",headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",data:datas};request(param).then(function(){$scope.commentContent="",reload()},function(err){console.log(err)})},request({url:"../../data/song-list.json",method:"GET"}).then(function(rs){$scope.songsList=rs.data,init()},function(err){console(err)}),$scope.pageSearchList={pn:1,ps:3,pl:3,songId:$scope.songsListIndex+1,"switch":!0},$scope.getOrderList=function(args,success){var param={url:"http://anewsong.duapp.com/get-comment",method:"GET",params:args};request(param).then(function(rs){console.log(rs),rs.data&&(pn=$scope.pageSearchList.pn,rs.pa={total:rs.data.total,pn:$scope.pageSearchList.pn,ps:$scope.pageSearchList.ps},success(rs),console.log(rs),$scope.commentLists=rs.data.data,console.log($scope.commentLists))},function(err){console.log(err)})}}]);